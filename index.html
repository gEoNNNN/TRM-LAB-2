<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR Escape Room - Lab Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js for NFT markers -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* Message overlay */
    .message-overlay {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      z-index: 1000;
      max-width: 80%;
      text-align: center;
      font-size: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      display: none;
    }

    .message-overlay.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    /* Progress tracker */
    .progress-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 25px;
      border-radius: 25px;
      z-index: 999;
      display: flex;
      gap: 10px;
    }

    .marker-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .marker-indicator.active {
      background: #4CAF50;
      box-shadow: 0 0 10px #4CAF50;
    }

    /* Loading screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .loading-screen.hide {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <h1>ğŸ” AR Escape Room</h1>
    <p>Loading AR experience...</p>
  </div>

  <!-- Message Overlay -->
  <div class="message-overlay" id="messageOverlay"></div>

  <!-- Progress Bar -->
  <div class="progress-bar" id="progressBar">
    <div class="marker-indicator" data-marker="marker1"></div>
    <div class="marker-indicator" data-marker="marker2"></div>
    <div class="marker-indicator" data-marker="marker3"></div>
    <div class="marker-indicator" data-marker="marker4"></div>
    <div class="marker-indicator" data-marker="marker5"></div>
    <div class="marker-indicator" data-marker="marker6"></div>
    <div class="marker-indicator" data-marker="marker7"></div>
  </div>

  <!-- AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

    <!-- Camera -->
    <a-entity camera></a-entity>

    <!-- NFT Marker 1 - Book -->
    <a-nft
      id="marker1"
      type="nft"
      url="markers/1m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Book Object -->
      <a-entity 
        id="obj1"
        position="0 0 0"
        visible="false">
        <!-- Book pages -->
        <a-entity 
          geometry="primitive: box; width: 0.8; height: 1; depth: 0.1"
          material="color: #8B4513"
          position="0 0 0">
        </a-entity>
        <!-- Book cover -->
        <a-entity 
          geometry="primitive: box; width: 0.82; height: 1.02; depth: 0.02"
          material="color: #654321"
          position="0 0 0.06">
        </a-entity>
      </a-entity>
      <a-text 
        value="ğŸ“– BOOK" 
        position="0 1.5 0" 
        align="center" 
        color="#8B4513"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 2 - Rock -->
    <a-nft
      id="marker2"
      type="nft"
      url="markers/2m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <a-sphere 
        id="obj2"
        color="#696969"
        radius="0.3"
        position="0 0 0" 
        roughness="0.8"
        metalness="0.1"
        visible="false">
      </a-sphere>
      <a-text 
        value="ğŸª¨ ROCK" 
        position="0 1.5 0" 
        align="center" 
        color="#696969"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 3 - Feather -->
    <a-nft
      id="marker3"
      type="nft"
      url="markers/3m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <a-entity 
        id="obj3"
        geometry="primitive: plane; width: 0.8; height: 2"
        material="color: white; opacity: 0.9; transparent: true"
        position="0 0 0" 
        rotation="0 0 20"
        visible="false">
      </a-entity>
      <a-text 
        value="ğŸª¶ FEATHER" 
        position="0 1.5 0" 
        align="center" 
        color="#F0F8FF"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 4 - Key -->
    <a-nft
      id="marker4"
      type="nft"
      url="markers/4m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <a-entity 
        id="obj4"
        position="0 0 0"
        visible="false">
        <!-- Key shaft -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.05; height: 1.5"
          material="color: #FFD700; metalness: 0.8; roughness: 0.2"
          position="0 0 0">
        </a-entity>
        <!-- Key head -->
        <a-entity 
          geometry="primitive: torus; radius: 0.25; radiusTubular: 0.05"
          material="color: #FFD700; metalness: 0.8; roughness: 0.2"
          position="0 0.7 0">
        </a-entity>
        <!-- Key teeth -->
        <a-entity 
          geometry="primitive: box; width: 0.3; height: 0.1; depth: 0.05"
          material="color: #FFD700; metalness: 0.8; roughness: 0.2"
          position="0.15 -0.7 0">
        </a-entity>
      </a-entity>
      <a-text 
        value="ğŸ”‘ KEY" 
        position="0 1.5 0" 
        align="center" 
        color="#FFD700"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 5 - Flower -->
    <a-nft
      id="marker5"
      type="nft"
      url="markers/5m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <a-entity 
        id="obj5"
        position="0 0 0"
        visible="false">
        <!-- Flower stem -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.02; height: 1"
          material="color: #228B22"
          position="0 -0.5 0">
        </a-entity>
        <!-- Flower petals -->
        <a-entity 
          geometry="primitive: sphere; radius: 0.3"
          material="color: #FFFF00"
          position="0 0 0">
        </a-entity>
        <!-- Flower center -->
        <a-entity 
          geometry="primitive: sphere; radius: 0.1"
          material="color: #FFA500"
          position="0 0 0.25">
        </a-entity>
      </a-entity>
      <a-text 
        value="ğŸŒ¼ FLOWER" 
        position="0 1.5 0" 
        align="center" 
        color="#FFFF00"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 6 - Candle -->
    <a-nft
      id="marker6"
      type="nft"
      url="markers/6m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <a-entity 
        id="obj6"
        position="0 0 0"
        visible="false">
        <!-- Candle body -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.15; height: 1"
          material="color: #F5DEB3"
          position="0 0 0">
        </a-entity>
        <!-- Wick -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.01; height: 0.1"
          material="color: #2F4F4F"
          position="0 0.55 0">
        </a-entity>
        <!-- Flame -->
        <a-entity 
          geometry="primitive: sphere; radius: 0.05"
          material="color: #FF4500; emissive: #FF4500; emissiveIntensity: 0.5"
          position="0 0.65 0">
        </a-entity>
      </a-entity>
      <a-text 
        value="ğŸ•¯ï¸ CANDLE" 
        position="0 1.5 0" 
        align="center" 
        color="#F5DEB3"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 7 - Village Emblem -->
    <a-nft
      id="marker7"
      type="nft"
      url="markers/7m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <a-entity 
        id="obj7"
        position="0 0 0"
        visible="false">
        <!-- Shield base -->
        <a-entity 
          geometry="primitive: box; width: 0.8; height: 1; depth: 0.1"
          material="color: #8B4513; roughness: 0.8"
          position="0 0 0">
        </a-entity>
        <!-- Emblem symbol (cross) -->
        <a-entity 
          geometry="primitive: box; width: 0.1; height: 0.6; depth: 0.05"
          material="color: #FFD700"
          position="0 0 0.06">
        </a-entity>
        <a-entity 
          geometry="primitive: box; width: 0.4; height: 0.1; depth: 0.05"
          material="color: #FFD700"
          position="0 0 0.06">
        </a-entity>
      </a-entity>
      <a-text 
        value="ğŸ›¡ï¸ VILLAGE EMBLEM" 
        position="0 1.5 0" 
        align="center" 
        color="#8B4513"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>
  </a-scene>

  <script>
    // Game state
    const gameState = {
      scannedMarkers: new Set(),
      currentSequence: ['marker1', 'marker2', 'marker3', 'marker4', 'marker5', 'marker6', 'marker7'],
      currentPuzzle: null,
      markerOrder: []
    };

    // Wait for scene to load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hide');
        showMessage("ğŸ§™ A wise wizard awaits with tales of legend...", 3000);
      }, 2000);
    });

    // Marker detection handlers
    const markers = ['marker1', 'marker2', 'marker3', 'marker4', 'marker5', 'marker6', 'marker7'];
    
    markers.forEach(markerId => {
      const markerEl = document.getElementById(markerId);
      
      markerEl.addEventListener('markerFound', () => {
        console.log(`${markerId} found`);
        handleMarkerFound(markerId);
      });

      markerEl.addEventListener('markerLost', () => {
        console.log(`${markerId} lost`);
      });
    });

    function handleMarkerFound(markerId) {
      console.log(`Marker ${markerId} detected!`);
      
      // Check if already scanned
      if (gameState.scannedMarkers.has(markerId)) {
        showMessage("âœ“ Already scanned!", 2000);
        return;
      }

      // Check if it's the correct sequence
      const expectedNext = gameState.currentSequence[gameState.scannedMarkers.size];
      
      if (markerId !== expectedNext) {
        showMessage(`âŒ Wrong marker! Scan in the correct order.`, 2500);
        return;
      }

      // Unlock marker immediately
      gameState.scannedMarkers.add(markerId);
      gameState.markerOrder.push(markerId);
      
      // Update progress bar
      updateProgressBar(markerId);
      
      // Show the 3D object
      revealMarkerObject(markerId);
      
      // Show success message
      showMessage(`âœ“ ${getMarkerName(markerId)} unlocked!`, 2000);
      
      // Check if game is complete
      if (gameState.scannedMarkers.size === 7) {
        setTimeout(() => {
          showMessage("ğŸ‰ Victory! You are the Dragon Slayer! ğŸ‘‘ğŸ‰âš”ï¸", 5000);
        }, 2500);
      } else {
        // Show hint for next marker
        setTimeout(() => {
          const hints = {
            'marker1': 'ğŸ“œ "Seek the ancient tome where dragon secrets are written..."',
            'marker2': 'ğŸ¯ "A hunter needs a weapon that strikes from afar..."',
            'marker3': 'ğŸ§ª "To summon the beast, brew the mystic elixir..."',
            'marker4': 'ğŸ‰ "The potion is ready. The dragon awaits your challenge..."',
            'marker5': 'âš”ï¸ "From the fallen beast, claim your legendary reward..."',
            'marker6': 'ğŸ‘‘ "The victor\'s seat awaits. Take your rightful throne..."'
          };
          const nextHint = hints[markerId];
          if (nextHint) {
            showMessage(nextHint, 4000);
          }
        }, 2500);
      }
    }

    function revealMarkerObject(markerId) {
      console.log(`Revealing object for ${markerId}`);
      
      // Make all child entities visible
      const markerEl = document.getElementById(markerId);
      if (!markerEl) {
        console.error(`Marker element ${markerId} not found`);
        return;
      }
      
      const entities = markerEl.querySelectorAll('a-entity, a-text, a-sphere');
      console.log(`Found ${entities.length} entities to reveal`);
      
      entities.forEach(el => {
        el.setAttribute('visible', 'true');
        console.log('Made entity visible:', el);
      });
    }

    function updateProgressBar(markerId) {
      const indicator = document.querySelector(`.marker-indicator[data-marker="${markerId}"]`);
      if (indicator) {
        indicator.classList.add('active');
      }
    }

    function showMessage(text, duration = 2000) {
      const overlay = document.getElementById('messageOverlay');
      overlay.textContent = text;
      overlay.classList.add('show');
      
      setTimeout(() => {
        overlay.classList.remove('show');
      }, duration);
    }

    function getMarkerName(markerId) {
      const names = {
        'marker1': 'ğŸ“– Book',
        'marker2': 'ğŸª¨ Rock',
        'marker3': 'ğŸª¶ Feather',
        'marker4': 'ğŸ”‘ Key',
        'marker5': 'ğŸŒ¼ Flower',
        'marker6': 'ğŸ•¯ï¸ Candle',
        'marker7': 'ğŸ›¡ï¸ Village Emblem'
      };
      return names[markerId] || markerId;
    }
  </script>
</body>
</html>
