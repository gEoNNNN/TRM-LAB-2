<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR Escape Room - Lab Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js for NFT markers -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* Message overlay */
    .message-overlay {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      z-index: 1000;
      max-width: 80%;
      text-align: center;
      font-size: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      display: none;
    }

    .message-overlay.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    /* Progress tracker */
    .progress-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 25px;
      border-radius: 25px;
      z-index: 999;
      display: flex;
      gap: 10px;
    }

    .marker-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .marker-indicator.active {
      background: #4CAF50;
      box-shadow: 0 0 10px #4CAF50;
    }

    /* Puzzle modal */
    .puzzle-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .puzzle-modal.show {
      display: flex;
    }

    .puzzle-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 400px;
      text-align: center;
    }

    .puzzle-content h2 {
      margin-top: 0;
      color: #333;
    }

    .puzzle-content input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .puzzle-content button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }

    .puzzle-content button:hover {
      background: #45a049;
    }

    .puzzle-content button.cancel {
      background: #f44336;
    }

    .puzzle-content button.cancel:hover {
      background: #da190b;
    }

    /* Loading screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .loading-screen.hide {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <h1>üîê AR Escape Room</h1>
    <p>Loading AR experience...</p>
  </div>

  <!-- Message Overlay -->
  <div class="message-overlay" id="messageOverlay"></div>

  <!-- Progress Bar -->
  <div class="progress-bar" id="progressBar">
    <div class="marker-indicator" data-marker="marker1"></div>
    <div class="marker-indicator" data-marker="marker2"></div>
    <div class="marker-indicator" data-marker="marker3"></div>
    <div class="marker-indicator" data-marker="marker4"></div>
    <div class="marker-indicator" data-marker="marker5"></div>
    <div class="marker-indicator" data-marker="marker6"></div>
    <div class="marker-indicator" data-marker="marker7"></div>
  </div>

  <!-- Puzzle Modal -->
  <div class="puzzle-modal" id="puzzleModal">
    <div class="puzzle-content">
      <h2 id="puzzleTitle">Puzzle</h2>
      <p id="puzzleQuestion"></p>
      <input type="text" id="puzzleAnswer" placeholder="Enter your answer">
      <div>
        <button onclick="submitPuzzle()">Submit</button>
        <button class="cancel" onclick="closePuzzle()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

    <!-- Camera -->
    <a-entity camera></a-entity>

    <!-- NFT Marker 1 -->
    <a-nft
      id="marker1"
      type="nft"
      url="markers/1m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 1 - Book -->
      <a-entity 
        id="obj1"
        gltf-model="url(assets/fallen_book.glb)"
        position="50 -400 0" 
        rotation="-75 0 0"
        scale="7 7 7"
      </a-entity>
      <a-text 
        value="üìñ BOOK" 
        position="0 1.5 0" 
        align="center" 
        color="#8B4513"
        scale="2 2 2">
      </a-text>
    </a-nft>

    <!-- NFT Marker 2 -->
    <a-nft
      id="marker2"
      type="nft"
      url="markers/2m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 2 - Rock -->
      <a-sphere 
        id="obj2"
        color="#696969"
        radius="0.3"
        position="0 0 0" 
        roughness="0.8"
        metalness="0.1"
        visible="false">
      </a-sphere>
      <a-text 
        value="ü™® ROCK" 
        position="0 1.5 0" 
        align="center" 
        color="#696969"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 3 -->
    <a-nft
      id="marker3"
      type="nft"
      url="markers/3m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 3 - Feather -->
      <a-entity 
        id="obj3"
        geometry="primitive: plane; width: 0.8; height: 2"
        material="color: white; opacity: 0.9; transparent: true"
        position="0 0 0" 
        rotation="0 0 20"
        visible="false">
      </a-entity>
      <a-text 
        value="ü™∂ FEATHER" 
        position="0 1.5 0" 
        align="center" 
        color="#F0F8FF"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 4 -->
    <a-nft
      id="marker4"
      type="nft"
      url="markers/4m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 4 - Key -->
      <a-entity 
        id="obj4"
        geometry="primitive: cylinder; radius: 0.05; height: 1.5"
        material="color: #FFD700; metalness: 0.8; roughness: 0.2"
        position="0 0 0"
        visible="false">
        <!-- Key head -->
        <a-entity 
          geometry="primitive: torus; radius: 0.25; radiusTubular: 0.05"
          material="color: #FFD700; metalness: 0.8; roughness: 0.2"
          position="0 0.7 0">
        </a-entity>
        <!-- Key teeth -->
        <a-entity 
          geometry="primitive: box; width: 0.3; height: 0.1; depth: 0.05"
          material="color: #FFD700; metalness: 0.8; roughness: 0.2"
          position="0.15 -0.7 0">
        </a-entity>
      </a-entity>
      <a-text 
        value="üîë KEY" 
        position="0 1.5 0" 
        align="center" 
        color="#FFD700"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 5 -->
    <a-nft
      id="marker5"
      type="nft"
      url="markers/5m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 5 - Flower -->
      <a-entity 
        id="obj5"
        position="0 0 0"
        visible="false">
        <!-- Flower stem -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.02; height: 1"
          material="color: #228B22"
          position="0 -0.5 0">
        </a-entity>
        <!-- Flower petals -->
        <a-entity 
          geometry="primitive: sphere; radius: 0.3"
          material="color: #FFFF00"
          position="0 0 0">
        </a-entity>
        <!-- Flower center -->
        <a-entity 
          geometry="primitive: sphere; radius: 0.1"
          material="color: #FFA500"
          position="0 0 0.25">
        </a-entity>
      </a-entity>
      <a-text 
        value="üåº FLOWER" 
        position="0 1.5 0" 
        align="center" 
        color="#FFFF00"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 6 -->
    <a-nft
      id="marker6"
      type="nft"
      url="markers/6m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 6 - Candle -->
      <a-entity 
        id="obj6"
        position="0 0 0"
        visible="false">
        <!-- Candle body -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.15; height: 1"
          material="color: #F5DEB3"
          position="0 0 0">
        </a-entity>
        <!-- Wick -->
        <a-entity 
          geometry="primitive: cylinder; radius: 0.01; height: 0.1"
          material="color: #2F4F4F"
          position="0 0.55 0">
        </a-entity>
        <!-- Flame -->
        <a-entity 
          geometry="primitive: sphere; radius: 0.05"
          material="color: #FF4500; emissive: #FF4500; emissiveIntensity: 0.5"
          position="0 0.65 0">
        </a-entity>
      </a-entity>
      <a-text 
        value="üïØÔ∏è CANDLE" 
        position="0 1.5 0" 
        align="center" 
        color="#F5DEB3"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>

    <!-- NFT Marker 7 -->
    <a-nft
      id="marker7"
      type="nft"
      url="markers/7m"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- 3D Object for Marker 7 - Village Emblem -->
      <a-entity 
        id="obj7"
        position="0 0 0"
        visible="false">
        <!-- Shield base -->
        <a-entity 
          geometry="primitive: box; width: 0.8; height: 1; depth: 0.1"
          material="color: #8B4513; roughness: 0.8"
          position="0 0 0">
        </a-entity>
        <!-- Emblem symbol (cross) -->
        <a-entity 
          geometry="primitive: box; width: 0.1; height: 0.6; depth: 0.05"
          material="color: #FFD700"
          position="0 0 0.06">
        </a-entity>
        <a-entity 
          geometry="primitive: box; width: 0.4; height: 0.1; depth: 0.05"
          material="color: #FFD700"
          position="0 0 0.06">
        </a-entity>
      </a-entity>
      <a-text 
        value="üõ°Ô∏è VILLAGE EMBLEM" 
        position="0 1.5 0" 
        align="center" 
        color="#8B4513"
        scale="2 2 2"
        visible="false">
      </a-text>
    </a-nft>
  </a-scene>

  <script>
    // Game state
    const gameState = {
      scannedMarkers: new Set(),
      currentSequence: ['marker1', 'marker2', 'marker3', 'marker4', 'marker5', 'marker6', 'marker7'],
      puzzles: {
        marker1: {
          question: "I hold knowledge and stories within my pages. What am I?",
          answer: "book",
          hint: "Open me to learn..."
        },
        marker2: {
          question: "Solid and steady, from the earth I came. What am I?",
          answer: "rock",
          hint: "Hard as stone..."
        },
        marker3: {
          question: "Light as air, I help birds fly. What am I?",
          answer: "feather",
          hint: "Soft and weightless..."
        },
        marker4: {
          question: "I unlock doors and secrets alike. What am I?",
          answer: "key",
          hint: "Turn me to open..."
        },
        marker5: {
          question: "Colorful and fragrant, I bloom in spring. What am I?",
          answer: "flower",
          hint: "I need sun and water..."
        },
        marker6: {
          question: "I light the darkness with my gentle flame. What am I?",
          answer: "candle",
          hint: "I burn bright..."
        },
        marker7: {
          question: "I represent the village and its people. What am I?",
          answer: "emblem",
          hint: "A symbol of unity..."
        }
      },
      currentPuzzle: null,
      markerOrder: []
    };

    // Wait for scene to load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hide');
        showMessage("üßô A wise wizard awaits with tales of legend...", 3000);
      }, 2000);
    });

    // Marker detection handlers
    const markers = ['marker1', 'marker2', 'marker3', 'marker4', 'marker5', 'marker6', 'marker7'];
    
    markers.forEach(markerId => {
      const markerEl = document.getElementById(markerId);
      
      markerEl.addEventListener('markerFound', () => {
        console.log(`${markerId} found`);
        handleMarkerFound(markerId);
      });

      markerEl.addEventListener('markerLost', () => {
        console.log(`${markerId} lost`);
      });
    });

    function handleMarkerFound(markerId) {
      // Check if already scanned
      if (gameState.scannedMarkers.has(markerId)) {
        showMessage("‚úì Already scanned!", 2000);
        return;
      }

      // Check if it's the correct sequence
      const expectedNext = gameState.currentSequence[gameState.scannedMarkers.size];
      
      if (markerId !== expectedNext) {
        showMessage(`‚ùå Wrong marker! Scan in the correct order.`, 2500);
        return;
      }

      // Unlock marker immediately without puzzle
      gameState.scannedMarkers.add(markerId);
      gameState.markerOrder.push(markerId);
      
      // Update progress bar
      updateProgressBar(markerId);
      
      // Show the 3D object
      revealMarkerObject(markerId);
      
      // Show success message
      showMessage(`‚úì ${getMarkerName(markerId)} unlocked!`, 2000);
      
      // Check if game is complete
      if (gameState.scannedMarkers.size === 7) {
        setTimeout(() => {
          showMessage("üéâ Victory! You are the Dragon Slayer! üëëüêâ‚öîÔ∏è", 5000);
        }, 2500);
      } else {
        // Show cryptic hint for next marker
        setTimeout(() => {
          const hints = {
            'marker1': 'üìú "Seek the ancient tome where dragon secrets are written..."',
            'marker2': 'üéØ "A hunter needs a weapon that strikes from afar..."',
            'marker3': 'üß™ "To summon the beast, brew the mystic elixir..."',
            'marker4': 'üêâ "The potion is ready. The dragon awaits your challenge..."',
            'marker5': '‚öîÔ∏è "From the fallen beast, claim your legendary reward..."',
            'marker6': 'üëë "The victor\'s seat awaits. Take your rightful throne..."'
          };
          const nextHint = hints[markerId];
          if (nextHint) {
            showMessage(nextHint, 4000);
          }
        }, 2500);
      }
    }

    function showPuzzle(markerId) {
      const puzzle = gameState.puzzles[markerId];
      document.getElementById('puzzleTitle').textContent = `Puzzle: ${getMarkerName(markerId)}`;
      document.getElementById('puzzleQuestion').textContent = puzzle.question;
      document.getElementById('puzzleAnswer').value = '';
      document.getElementById('puzzleModal').classList.add('show');
    }

    function closePuzzle() {
      document.getElementById('puzzleModal').classList.remove('show');
      gameState.currentPuzzle = null;
    }

    function submitPuzzle() {
      const markerId = gameState.currentPuzzle;
      const userAnswer = document.getElementById('puzzleAnswer').value.trim().toLowerCase();
      const correctAnswer = gameState.puzzles[markerId].answer.toLowerCase();

      if (userAnswer === correctAnswer) {
        // Correct answer!
        gameState.scannedMarkers.add(markerId);
        gameState.markerOrder.push(markerId);
        closePuzzle();
        
        // Update progress bar
        updateProgressBar(markerId);
        
        // Show the 3D object
        revealMarkerObject(markerId);
        
        // Show success message
        showMessage(`‚úì Correct! ${getMarkerName(markerId)} unlocked!`, 3000);
        
        // Check if game is complete
        if (gameState.scannedMarkers.size === 7) {
          setTimeout(() => {
            showMessage("üéâ Victory! You are the Dragon Slayer! üëëüêâ‚öîÔ∏è", 5000);
          }, 3000);
        } else {
          setTimeout(() => {
            showMessage(`Next: Scan ${getMarkerName(gameState.currentSequence[gameState.scannedMarkers.size])}`, 3000);
          }, 3500);
        }
      } else {
        // Wrong answer
        showMessage(`‚ùå Wrong answer! Hint: ${gameState.puzzles[markerId].hint}`, 3000);
      }
    }

    function revealMarkerObject(markerId) {
      // Make all child entities visible
      const markerEl = document.getElementById(markerId);
      const entities = markerEl.querySelectorAll('a-entity, a-text');
      entities.forEach(el => {
        el.setAttribute('visible', 'true');
      });
    }

    function updateProgressBar(markerId) {
      const indicator = document.querySelector(`.marker-indicator[data-marker="${markerId}"]`);
      if (indicator) {
        indicator.classList.add('active');
      }
    }

    function showMessage(text, duration = 2000) {
      const overlay = document.getElementById('messageOverlay');
      overlay.textContent = text;
      overlay.classList.add('show');
      
      setTimeout(() => {
        overlay.classList.remove('show');
      }, duration);
    }

    function getMarkerName(markerId) {
      const names = {
        'marker1': 'üìñ Book',
        'marker2': 'ü™® Rock',
        'marker3': 'ü™∂ Feather',
        'marker4': 'üîë Key',
        'marker5': 'üåº Flower',
        'marker6': 'üïØÔ∏è Candle',
        'marker7': 'üõ°Ô∏è Village Emblem'
      };
      return names[markerId] || markerId;
    }

    // Allow Enter key in puzzle input
    document.getElementById('puzzleAnswer')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitPuzzle();
      }
    });
  </script>
</body>
</html>
